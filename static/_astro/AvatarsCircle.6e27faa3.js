import{r as h}from"./index.d496d5ee.js";import{c as R,a as D,A as b}from"./AvatarIcon.ec88cd77.js";import{j as n,W as f,g as v,u as x}from"./UseWebSocket.b87fe84a.js";import{F as w,a as _}from"./File.017130be.js";import{p as T,a as y,e as S,o as E,i as L,m as M}from"./Parsers.472ab83d.js";import"./index.cca61219.js";function F({children:i,open:e}){return e?n.jsx("div",{className:"h-full w-full flex justify-center mt-[]",children:n.jsx("div",{style:{position:"absolute",transformOrigin:"center center"},className:"jdhskf",children:n.jsx(R,{children:n.jsx(D,{className:"p-4",children:i})})})}):n.jsx(n.Fragment,{})}function N({text:i}){const[e,t]=h.useState(!!i);return h.useEffect(()=>{i&&(t(!0),setTimeout(()=>{t(!1)},3500))},[i]),n.jsx(F,{open:e,children:n.jsx(n.Fragment,{children:i})})}class A{constructor(e,t,s,r=s&&t.createDataChannel("sendDataChannel",{ordered:!0})||void 0,a=[]){this.id=e,this.rtc=t,this.create=s,this.dc=r,this.holder=a,!this.create&&this.rtc.addEventListener("datachannel",o=>{this.dc=o.channel,this.config(o.channel)}),r&&this.config(r)}config(e){e.binaryType="arraybuffer";var t=w.Receiver({onBegin:s=>{_.instance.registerFile(s.uuid,s.id_from,s.id_to,s.name,s.maxChunks,s.lastModifiedDate,s.size,s.type)},onEnd:s=>{_.instance.finishFile(s.uuid,s.file,s.url)},onProgress:s=>{_.instance.updateFile(s.uuid,s.currentPosition)}});e.onmessage=function(s){t.receive(s)},e.addEventListener("open",s=>{this.holder.forEach(r=>r(e))})}close(){this.dc&&this.dc.close()}send(e){this.dc&&this.dc.readyState==="open"&&e(this.dc)||this.holder.push(e)}}class W{constructor(e,t,s,r=new RTCPeerConnection,a=new A(e,r,!s)){this.id_to=e,this.id_from=t,this.offer=s,this.rtc=r,this.dc=a,this.rtc.addEventListener("icecandidate",async o=>{f.instance.sendMessage(j("icecandidate",this.id_to,o.candidate))}),this.offer?(this.rtc.setRemoteDescription(this.offer),this.rtc.createAnswer().then(o=>this.rtc.setLocalDescription(new RTCSessionDescription(o))).then(()=>{f.instance.sendMessage(j("answer",this.id_to,this.rtc.localDescription))})):this.rtc.createOffer().then(o=>this.rtc.setLocalDescription(new RTCSessionDescription(o))).then(()=>{f.instance.sendMessage(j("offer",this.id_to,this.rtc.localDescription))})}disconnect(){this.dc.close(),this.rtc.close()}sendFiles(e){e.forEach(t=>{this.sendData(t)})}sendData(e){this.dc.send(t=>{w.Send({file:e,channel:t,interval:5,id_from:this.id_from,id_to:this.id_to,chunkSize:64e3,onBegin:s=>{},onEnd:s=>{},onProgress:s=>{}})})}}class u{constructor(e=new Map,t=new Map,s=void 0){this._WebRTCs=e,this._Listeners=t,this.id_from=s,f.instance.add(T,this.listener()),f.instance.add(y,r=>{this._WebRTCs.forEach(a=>{!r.ids.includes(a.id_to)&&this.delete(a)})})}static instance=new u;registerListener(e,t){const s=this._Listeners.get(e);s?s.push(t):this._Listeners.set(e,[t])}listener(){const e=this._WebRTCs;return t=>{let s=e.get(t.id);if(!s&&t.type==="offer"&&this.register(t.id,t.json),!!s){if(t.type==="icecandidate"){if(!t.json)return;s.rtc.addIceCandidate(t.json)}if(t.type==="answer"){if(!t.json)return;s.rtc.setRemoteDescription(t.json)}}}}register(e,t){if(this._WebRTCs.has(e))return S({message:"already"});const s=new W(e,this.id_from||"",t);return this._WebRTCs.set(e,s),E(s)}sendFiles(e,t){const s=this._WebRTCs.get(e);s&&s.sendFiles(t)}delete(e){e.disconnect(),this._Listeners.delete(e.id_to),this._WebRTCs.delete(e.id_to)}}function j(i,e,t){return`/direct_message ${e} ${i} ${JSON.stringify(t)}`}function k({files:i,id:e,cancelFiles:t}){return n.jsx(F,{open:i!==void 0,children:n.jsxs("div",{className:"px-1 py-2 flex-col",children:[n.jsx("div",{className:" max-w-[80vw] text-ellipsis mb-2",children:i?.length===1&&n.jsxs(n.Fragment,{children:["Selected ",i[0].name]})||n.jsxs(n.Fragment,{children:["Selected ",i?.length," files"]})}),n.jsxs("div",{className:"flex justify-around gap-2",children:[n.jsx(v,{onClick:()=>{u.instance.register(e),u.instance.sendFiles(e,i||[]),t()},color:"success",variant:"bordered",children:"Send"}),n.jsx(v,{onClick:t,color:"danger",variant:"bordered",children:"Cancel"})]})]})})}const P=i=>{i.preventDefault(),i.stopPropagation()};function O({rotate:i,translateX:e,id:t,text:s}){const[r,a]=h.useState(void 0),o=h.useRef(null),l=h.useRef(null),m=c=>{a([...c])};h.useEffect(()=>{!l||!l.current||(l.current.addEventListener("dragover",P),l.current.addEventListener("drop",p))},[]);const p=c=>{if(c.preventDefault(),c.stopPropagation(),!c.dataTransfer)return;const{files:d}=c.dataTransfer;d&&d.length&&m(d)},g=c=>{!c.target.files||!c.target.files.length||(m(c.target.files),c.target.value="",c.target.files=null)};return n.jsx(n.Fragment,{children:n.jsx("div",{style:{transform:`rotate(${i}deg) translateX(${e}%)`},className:"absolute sm:h-16 sm:w-16 sm:left-[calc(50%_-_32px)] sm:top-[calc(50%_-_32px)] h-12 w-12 left-[calc(50%_-_24px)] top-[calc(50%_-_24px)] rounded-[50%]",children:n.jsxs("div",{style:{position:"absolute",transform:`rotate(${-i||0}deg)`,transformOrigin:"center center"},children:[n.jsxs("div",{ref:l,onClick:()=>o.current&&o.current.click(),className:"transition-transform transform-gpu hover:scale-125 w-full h-full",children:[n.jsx("input",{className:"hidden",ref:o,type:"file",multiple:!0,onChange:g}),n.jsx(b,{id:t,rotate:0})]}),n.jsx(k,{files:r,id:t,cancelFiles:()=>a(void 0)}),n.jsx(N,{text:s})]})})})}function C(i,e){for(let t=0;t<i.length-1;t++)if(e(i[t],i[t+1]))return t+1}function $({id:i,order:e,count:t,mess:s}){const r=[0,10,32],a=C(r,(c,d)=>c<=e-1&&e-1<=d),o=C(r,(c,d)=>c<=t-1&&t-1<=d);if(!a||!o)return n.jsx(n.Fragment,{});const l=e-1-r[a-1],p=360/(o===a?t-1-r[a-1]:r[a]-r[a-1])*l+270,g=a*200;return n.jsx(O,{rotate:p,translateX:g,id:i,text:s})}function z({rotate:i,translateX:e,id:t}){return n.jsxs("div",{style:{transform:`rotate(${i}deg) translateX(${e}%)`},className:"absolute sm:h-16 sm:w-16 sm:left-[calc(50%_-_32px)] sm:top-[calc(50%_-_32px)] h-12 w-12 left-[calc(50%_-_24px)] top-[calc(50%_-_24px)] rounded-[50%]",children:[n.jsx(b,{id:t,rotate:i}),n.jsx("div",{className:"flex flex-col items-center w-full text-tiny mt-1 text-[#A1A1AA] invisible",children:n.jsx("div",{children:"You"})})]})}function q(){const{lastMess:i}=x(L,"/id"),{lastMess:e}=x(y,"/members"),{lastMess:t}=x(M);if(h.useEffect(()=>{i&&(u.instance.id_from=i)},[i]),!e||!i)return n.jsx(n.Fragment,{});const s=e.ids.filter(r=>r!==i).sort();return n.jsxs("div",{children:[n.jsx(z,{id:i,rotate:0,translateX:0}),s.map((r,a)=>n.jsx($,{id:r,order:a+2,count:e.ids.length,mess:t?.id===r?t.mess:void 0},a))]})}export{q as default};
