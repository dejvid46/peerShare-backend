class F{constructor(t=new Map,s=new Array){this._Files=t,this._onNewFile=s}static instance=new F;onNewFile(t){this._onNewFile.push(t)}deleteFile(t){this._Files.delete(t)}onFileChange(t,s){const i=this._Files.get(t);i&&i.listeners.push(s)}updateFile(t,s){const i=this._Files.get(t);i&&(i.position=s,i.listeners.forEach(e=>e(i)))}getFile(t){return this._Files.get(t)}finishFile(t,s,i){let e=this._Files.get(t);if(e){const r={id_from:e.id_from,id_to:e.id_to,name:e.name,maxChunks:e.maxChunks,lastModifiedDate:e.lastModifiedDate,size:e.size,type:e.type,blob:s,listeners:e.listeners,position:e.position,state:"uploaded",file:i};this._Files.set(t,r),r.listeners.forEach(u=>u(r))}}registerFile(t,s,i,e,r,u,a,o){this._Files.set(t,{id_from:s,id_to:i,name:e,maxChunks:r,lastModifiedDate:u,size:a,type:o,listeners:[],position:0,state:"uploading"}),this._onNewFile.forEach(l=>l(t))}}const g={Send:function(n){const t=n.file,s=n.channel,i=n.chunkSize||40*1e3;let e=0;const a=Math.floor(Math.min(1e8,i)/i)*i,o=Math.ceil(t.size/i),l=(Math.random()*new Date().getTime()).toString(36).toUpperCase().replace(/\./g,"-");s.send(JSON.stringify({uuid:l,maxChunks:o,size:t.size,id_from:n.id_from,id_to:n.id_to,name:t.name,lastModifiedDate:t.lastModified,type:t.type,start:!0})),n.onBegin(t);let d,f=new FileReader;f.onloadend=function(h){h.target&&h.target.readyState==FileReader.DONE&&z(t.name,h.target.result,function(){e++,(e+1)*a<t.size?(d=t.slice(e*a,(e+1)*a),f.readAsArrayBuffer(d)):e*a<t.size?(d=t.slice(e*a,t.size),f.readAsArrayBuffer(d)):(s.send(JSON.stringify({uuid:l,maxChunks:o,size:t.size,id_from:n.id_from,id_to:n.id_to,name:t.name,lastModifiedDate:t.lastModified,type:t.type,end:!0})),URL.createObjectURL(t),n.onEnd(t))})},d=t.slice(e*a,(e+1)*a),f.readAsArrayBuffer(d);let v,c=0,p=[];function z(h,w,y){v=Math.ceil(w.byteLength/i);for(var m=0;m<v;m++){var _=m*i;p[c]=w.slice(_,Math.min(_+i,w.byteLength)),b.ArrayBufferToDataURL(p[c],function(S){s.send(JSON.stringify({uuid:l,value:S,currentPosition:c,maxChunks:o}))}),c++}n.onProgress&&n.onProgress({currentPosition:c,maxChunks:o,uuid:l}),n.interval==0||typeof n.interval>"u"?y():setTimeout(y,n.interval)}},Receiver:function(n){var t={};function s(i){const e=JSON.parse(i.data);if(e.start&&!t[e.uuid]&&(t[e.uuid]=[],n.onBegin&&n.onBegin(e)),!e.end&&e.value&&t[e.uuid].push(e.value),e.end){for(var r=t[e.uuid],u=[],a=r.length,o=0;o<a;o++)r[o]&&b.DataURLToBlob(r[o],function(d){u.push(d)});var l=new Blob(u,{type:i.type});if(l.size||console.error("Something went wrong. Blob Size is 0."),n.onEnd){const d=new File([l],e.name);n.onEnd({uuid:e.uuid,blob:l,file:d})}}e.value&&n.onProgress&&n.onProgress({uuid:e.uuid,currentPosition:e.currentPosition})}return{receive:s}}};function B(n,t,s){const i=URL.createObjectURL(t);var e=document.createElement("a");e.href=i,e.target="_blank",e.download=s||i;var r=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0});e.dispatchEvent(r),(window.URL||window.webkitURL).revokeObjectURL(e.href),document.body.insertBefore(e,document.body.firstChild),F.instance.deleteFile(n)}var b={ArrayBufferToDataURL:function(n,t){var s=new Blob([n]),i=new FileReader;i.onload=function(e){e.target&&t(e.target.result)},i.readAsDataURL(s)},DataURLToBlob:function(n,t){for(var s=atob(n.substr(n.indexOf(",")+1)),i=s.length,e=new Uint8Array(i);i--;)e[i]=s.charCodeAt(i);t(new Blob([e]))}};export{g as F,B as S,F as a};
