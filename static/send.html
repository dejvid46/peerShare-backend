<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <h1>Helooo</h1>
    <form id="fileInfo">
        <input type="text" id="idInput" name="id" />
    </form>
    <button id="sendFile">Send</button>

    <script>
        function parseWs(input, startWith, jsonType, id) {
            const data = input.split(" ");
            if(data.shift() === startWith){
                if (startWith === "/direct_message") {
                    const getId = data.shift();
                    const json = JSON.parse(data.join(" "));
                    if (json.type === jsonType && id === undefined) { return {id: getId, value: json.value} }
                    if (json.type === jsonType && getId === id) { return json.value }
                    return undefined;
                }
                return data.join(" ");
            }
            return undefined;
        }

        function send(prefix, type, value) {
            return `${prefix} {"type": "${type}", "value": "${value}"}`;
        }

        function sendObj(prefix, type, value) {
            return `${prefix} {"type": "${type}", "value": ${JSON.stringify(value)}}`;
        }

        class WebRTC {
            constructor(ws, arrs, id, offer) {
                this.ws = ws;
                this.arrs = arrs;
                this.rtc = new RTCPeerConnection();
                this.id = id;
                this.offer = offer;
            }

            register(){

                this.arrs.push((e) => {
                    const value = parseWs(e.data, "/direct_message", "icecandidate", this.id);
                    if(value){ this.rtc.addIceCandidate(new RTCIceCandidate(value)) }
                });
                this.arrs.push(this.answer =(e) => {
                    const value = parseWs(e.data, "/direct_message", "answer", this.id);
                    if(value){
                        this.rtc.setRemoteDescription(value);
                    }
                })
                
                this.rtc.createDataChannel('sendDataChannel');

                this.rtc.addEventListener('icecandidate', async event => {
                    this.ws.send(sendObj("/direct_message " + this.id, "icecandidate", event.candidate));
                });
                if(this.offer === undefined){
                    this.rtc.createOffer()
                        .then(offer => this.rtc.setLocalDescription(new RTCSessionDescription(offer)))
                        .then(() => {
                            console.log("pure: ", this.rtc.localDescription);
                            this.ws.send(sendObj("/direct_message " + this.id, "offer", this.rtc.localDescription))
                        });
                }else{
                    this.rtc.setRemoteDescription(this.offer);
                    this.rtc.createAnswer()
                        .then(answer => this.rtc.setLocalDescription(new RTCSessionDescription(answer)))
                        .then(() => (this.ws.send(sendObj("/direct_message " + this.id, "answer", this.rtc.localDescription))));
                }
            }
        }
    </script>

    <script>
        // socket
        const ws = new WebSocket("ws://127.0.0.1:8080/ws");

        let count = 0;


        let arrs = [];

        ws.onmessage = async (event) => {
            arrs.forEach(x => x(event));
        }

        arrs.push((e) => console.log(e.data));
        arrs.push((e) => {
            const res = parseWs(e.data, "/direct_message", "offer");
            if(res){
                arrs = [];
                arrs.push((e) => console.log(e.data));
                const webrtc = new WebRTC(ws, arrs, res.id, res.value);
                webrtc.register();
            }
        });

        const connectWith = () => {
            const id = document.querySelector('input#idInput').value;
            arrs = [];
            arrs.push((e) => console.log(e.data));
            const webrtc = new WebRTC(ws, arrs, id);
            webrtc.register();
        }
        const sendFileButton = document.querySelector('button#sendFile');
        sendFileButton.addEventListener('click', () => connectWith());



    </script>

    <script>
        // webrtc

        // const me = new RTCPeerConnection();
        // const someone = new RTCPeerConnection();

        // sendChannel = me.createDataChannel('sendDataChannel');
        // sendChannel.binaryType = 'arraybuffer';

        // me.addEventListener('icecandidate', async event => {
        //     await someone.addIceCandidate(event.candidate);
        // });

        // someone.addEventListener('icecandidate', async event => {
        //     await me.addIceCandidate(event.candidate);
        // });

        // me.createOffer()
        //     .then(offer => me.setLocalDescription(new RTCSessionDescription(offer)))
        //     .then(() => someone.setRemoteDescription(me.localDescription))
        //     .then(() => someone.createAnswer())
        //     .then(answer => someone.setLocalDescription(new RTCSessionDescription(answer)))
        //     .then(() => me.setRemoteDescription(someone.localDescription))
    </script>
</body>
</html>